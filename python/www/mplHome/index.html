<!DOCTYPE html>
<html>

<head>

    <meta charset="UTF-8">

    <title>MPL Mobile Trainer</title>

    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"/>

    <link rel="stylesheet" href="jquery.mobile/jquery.mobile-1.4.5.min.css" />
    <link rel="stylesheet" href="blueimp-gallery/css/blueimp-gallery.css">

    <style type='text/css'>
        html {
            background-color: #333;
        }
        @media only screen and (min-width: 600px) {
            .ui-page {
                width: 480px !important;
                margin: 0 auto !important;
                position: relative !important;
                border-right: 5px #666 outset !important;
                border-left: 5px #666 outset !important;
            }
        }
		
        p {
            font-family: Arial, Helvetica, sans-serif;
            font-size: 18;
        }
		#mtProgressBackground {
		  width: 100%;
		  height: 30px;
		  background-color: #ddd;
		}

		#mtProgressBar {
		  width: 0%;
		  height: 100%;
		  background-color: #4CAF50;
		}

		#mtProgressLabel {
		  text-align: center;
		  line-height: 30px;
		  color: white;
		}
		  
		#tacJoint1Background, #tacJoint2Background, #tacJoint3Background {
		  width: 100%;
		  height: 30px;
		  background-color: #ddd;
		  position:relative;
		}
		
		#tacJoint1Target, #tacJoint2Target , #tacJoint3Target{
		  width: 10%;
		  height: 100%;
		  background-color: #1E90FF;
		  margin-left: 0%;
		  position: absolute;
		}

		#tacJoint1Bar, #tacJoint2Bar, #tacJoint3Bar {
		  width: 5%;
		  height: 100%;
		  background-color: #4CAF50;
		  margin-left: 0%;
          position: absolute;
          z-index: 10;
		}

		#tacJoint1Label, #tacJoint2Label, #tacJoint3Label {
		  text-align: center;
		  line-height: 30px;
		  color: white;
		 }
		 
    </style>

    
    <script src="jquery.mobile/jquery-1.11.1.min.js"></script>
    <script src="jquery.mobile/jquery.mobile-1.4.5.min.js"></script>
    <script src="spacebrew.js/sb-1.4.1.min.js"></script>

    <script>
        // Spacebrew Object
        var sb, app_name = "MPL Control",
            values = {};

        // when page loads setup callbacks 
        //$(window).on("load", cbSwitch);

        // when page loads call spacebrew setup function 
        $(window).on("load", setupSpacebrew);

        // when the jquery mobile is ready to initialize the UI call the setUI function 
        $(document).bind("pageinit", setupUI);


            function flipChanged(e) {
		console.log("!!!! Changed !!!!");
		}

   	     $("#trainSwitch").on("change", flipChanged);


        function cbSwitch() {
            console.log("[Switch Callback Defined]");

            // Callbacks for state-based (slider) switches
            $('#trainSwitch').change(function() {
		console.log('!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! Got an event');
                if (this.checked) {
                    sb.send("cmdString", "string", "Cmd:AddDataOn")
                    //sendCmd("Cmd:AddDataOn")
                } else {
                    sb.send("cmdString", "string", "Cmd:AddDataOn")
//                    sendCmd("Cmd:AddDataOff")
                }
            });            

        }


        /**
         * setupSpacebrew Function that creates and configures the connection to the Spacebrew server.
         * 				  It is called when the page loads.
         */

        function setupSpacebrew() {
            var random_id = "0000" + Math.floor(Math.random() * 10000);

            app_name = app_name + ' ' + random_id.substring(random_id.length - 4);

            console.log("Setting up spacebrew connection");
            sb = new Spacebrew.Client("127.0.0.1");

            sb.name(app_name);
            sb.description("JHU/APL Mobile Training Interface");

            // configure the publication and subscription feeds
            sb.addPublish("cmdString", "string", "");
            sb.addSubscribe("statusString", "string");

            // override Spacebrew events - this is how you catch events coming from Spacebrew
            sb.onStringMessage = onStringMessage;
            sb.onOpen = onOpen;

            // connect to Spacebrew
            sb.connect();
            
            // listen to button clicks
            $("#ID_ADD").on("mousedown", function() {sendCmd("Cmd:Add")} );  // 4/5/2017 RSA: Moved to slider switch
            $("#ID_STOP").on("mousedown", function() {sendCmd("Cmd:Stop")} );  // 4/5/2017 RSA: Moved to slider switch
            $("#ID_CLEARCLASS").on("mousedown", function() {sendCmd("Cmd:ClearClass")} );
            $("#ID_CLEARALL").on("mousedown", function() {sendCmd("Cmd:ClearAll")} );
            $("#ID_TRAIN").on("mousedown", function() {sendCmd("Cmd:Train")} );
            $("#ID_SAVE").on("mousedown", function() {sendCmd("Cmd:Save")} );
            $("#ID_BACKUP").on("mousedown", function() {sendCmd("Cmd:Backup")} );
            $("#ID_SPEEDUP").on("mousedown", function() {sendCmd("Cmd:SpeedUp")} );
            $("#ID_SPEEDDOWN").on("mousedown", function() {sendCmd("Cmd:SpeedDown")} );
            $("#ID_HAND_SPEED_UP").on("mousedown", function() {sendCmd("Cmd:HandSpeedUp")} );
            $("#ID_HAND_SPEED_DOWN").on("mousedown", function() {sendCmd("Cmd:HandSpeedDown")} );
            $("#ID_PAUSE").on("mousedown", function() {sendCmd("Cmd:Pause")} );  // 4/5/2017 RSA: Moved to slider switch
            $("#ID_PAUSE_HAND").on("mousedown", function() {sendCmd("Cmd:PauseHand")} );  // 4/5/2017 RSA: Moved to slider switch
            $("#ID_MYO1").on("mousedown", function() {sendCmd("Cmd:RestartMyo1")} );
            $("#ID_MYO2").on("mousedown", function() {sendCmd("Cmd:RestartMyo2")} );
            $("#ID_REBOOT").on("mousedown", function() {sendCmd("Cmd:Reboot")} );
            $("#ID_SHUTDOWN").on("mousedown", function() {sendCmd("Cmd:Shutdown")} );
            $("#ID_ASSESSMENT_MT").on("mousedown", function() {startMT()} );
            $("#ID_ASSESSMENT_TAC1").on("mousedown", function() {startTAC1()} );
            $("#ID_ASSESSMENT_TAC3").on("mousedown", function() {startTAC3()} );
            
            $('#trainSwitch').change(function() {
		console.log('!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! Got an event');
                if (this.checked) {
                    sb.send("cmdString", "string", "Cmd:AddDataOn");
                    //sendCmd("Cmd:AddDataOn")
                } else {
                    sb.send("cmdString", "string", "Cmd:AddDataOn");
//                    sendCmd("Cmd:AddDataOff")
                }
            }); 
            
        };
        
        // global function called from index and galleryLinks.js
        function sendCmd(cmd) {
		
            console.log('Send ' + cmd);
            sb.send("cmdString", "string", cmd);
        };

        // Function that is called when Spacebrew connection is established
        function onOpen() {
            console.log('Spacebrew Connected');
            var message = "Connected as <strong>" + sb.name() + "</strong>";
            if (sb.name() === app_name) {
                message += "<br>You can customize this app's name in the query string by adding <strong>name=your_app_name</strong>."
            }
            $("#statusMsg").html(message);
        }


        /**
         * onStringMessage Function that is called whenever new spacebrew string messages are received.
         *          It accepts two parameters:
         * @param  {String} name    Holds name of the subscription feed channel
         * @param  {String} value 	Holds value received from the subscription feed
         */
         function onStringMessage( name, value ){
             console.log("[onStringMessage] string message received ", value);
                         var split_id = value.indexOf(":")
			 var cmd_type = value.slice(0,split_id);
			 var cmd_data = value.slice(split_id+1);
			 
             if (name == "statusString") {
				 if (cmd_type == "strStatus") {
					 $("#msg_status").html(cmd_data);
				 }         
				 if (cmd_type == "strTrainingMotion") {
					 $("#msg_train").text(cmd_data);
				 }         
				 if (cmd_type == "strOutputMotion") {
					 $("#main_output").text(cmd_data);
					 $("#mt_output").text(cmd_data);
					 $("#tac_output").text(cmd_data);
				 }
                 if (cmd_type == "strMotionTester") {
					 $("#mt_status").text(cmd_data);
				 }
				 if (cmd_type == "strMotionTesterProgress") {
					 updateMTProgressBar(cmd_data);
				 }
				 if (cmd_type == "strMotionTesterImage") {
					 updateMTImage(cmd_data);
				 }
				 if (cmd_type == "strTAC") {
					 $("#tac_status").text(cmd_data);
				 }
				 if (cmd_type == "strTACJoint1Name") {
					 $("#tacJoint1Name").text(cmd_data);
				 }
				 if (cmd_type == "strTACJoint1Bar") {
					 updateTACJointBar(cmd_data, "tacJoint1Bar", "tacJoint1Label");
				 }
				 if (cmd_type == "strTACJoint1Target") {
					updateTACJointTarget(cmd_data, "tacJoint1Target");
				 }
				 if (cmd_type == "strTACJoint1Error") {
					updateTACJointError(cmd_data, "tacJoint1Target");
				 }
				 if (cmd_type == "strTACJoint2Name") {
					 $("#tacJoint2Name").text(cmd_data);
				 }
				 if (cmd_type == "strTACJoint2Bar") {
					 updateTACJointBar(cmd_data, "tacJoint2Bar", "tacJoint2Label");
				 }
				 if (cmd_type == "strTACJoint2Target") {
					updateTACJointTarget(cmd_data, "tacJoint2Target");
				 }
				 if (cmd_type == "strTACJoint2Error") {
					updateTACJointError(cmd_data, "tacJoint2Target");
				 }
				 if (cmd_type == "strTACJoint3Name") {
					 $("#tacJoint3Name").text(cmd_data);
				 }
				 if (cmd_type == "strTACJoint3Bar") {
					 updateTACJointBar(cmd_data, "tacJoint3Bar", "tacJoint3Label");
				 }
				 if (cmd_type == "strTACJoint3Target") {
					updateTACJointTarget(cmd_data, "tacJoint3Target");
				 }
				 if (cmd_type == "strTACJoint3Error") {
					updateTACJointError(cmd_data, "tacJoint3Target");
				 }
			 }
         }   
           
         function startMT() {
            // Gather parameters to send to motion tester
            var repetitions = $("#ID_MT_REPETITIONS").val()
            var timeout = $("#ID_MT_TIMEOUT").val()
            var max_classifications = $("#ID_MT_MAX_CLASSIFICATIONS").val()
            sendCmd("Cmd:StartMotionTester-" + repetitions + "-" + timeout + "-" + max_classifications)
         }
         
         function startTAC1() {
            // Gather parameters to send to TAC1
            var repetitions = $("#ID_REPETITIONS").val()
            var timeout = $("#ID_TIMEOUT").val()
            var dwell_time = $("#ID_DWELL_TIME").val()
            var degree_error = $("#ID_DEGREE_ERROR").val()
            var grasp_error = $("#ID_GRASP_ERROR").val()
            sendCmd("Cmd:StartTAC1-" + repetitions + "-" + timeout + "-" + dwell_time + "-" + degree_error + "-" + grasp_error)
         }
         
         function startTAC3() {
            // Gather parameters to send to TAC3
            var repetitions = $("#ID_REPETITIONS").val()
            var timeout = $("#ID_TIMEOUT").val()
            var dwell_time = $("#ID_DWELL_TIME").val()
            var degree_error = $("#ID_DEGREE_ERROR").val()
            var grasp_error = $("#ID_GRASP_ERROR").val()
            sendCmd("Cmd:StartTAC3-" + repetitions + "-" + timeout + "-" + dwell_time + "-" + degree_error + "-" + grasp_error)
         }
         
		 // Function to update the motion tester progress bar based on user input
		 // See http://www.w3schools.com/howto/howto_js_progressbar.asp for details
		function updateMTProgressBar(percent) {
			var elem = document.getElementById("mtProgressBar");   
			elem.style.width = percent + '%'; 
			document.getElementById("mtProgressLabel").innerHTML = percent * 1  + '%';
		}
		
		// Function to update motion tester image based on class being assessed
		function updateMTImage(imageFile){
			document.getElementById("ID_MT_IMAGE").src=imageFile
		}
		
		function updateTACJointBar(value, barId, labelId) {
			var elem = document.getElementById(barId);   
			elem.style.marginLeft = value - 2.5 + '%'; // The 2.5 is to account for 5% width
			document.getElementById(labelId).innerHTML = Math.round(value * 1);
		}
		
		function updateTACJointError(value, elementId) {
			var elem = document.getElementById(elementId); 
            elem.style.width = value*2 + '%'			
		}
		
		function updateTACJointTarget(value, elementId) {
			var elem = document.getElementById(elementId);
			percentChar = elem.style.width
			percentNum  = percentChar.substring(0, percentChar.length - 1) // Remove percent sign
			halfWidth = percentNum * 1 / 2
			valuePercent = value * 1
			newMargin = valuePercent  - halfWidth
			newMarginPercent = newMargin * 1 + '%'
			elem.style.marginLeft = newMarginPercent;
		}
                
    </script>

</head>



<body>
	<!-- Main Mobile Trainer Page -->
    <div data-role="page" id="ID_MAIN_PAGE">
        <div data-role="header" data-theme="b" >
            <h1>MPL Mobile Trainer</h1>
        </div><!-- /header -->
		<div data-role="content">
			<div data-role="collapsible" data-collapsed-icon="gear" data-expanded-icon="gear">
			<h4>Configure</h4>
			<ul data-role="listview" data-inset="false">
			<li><a href="#" class="ui-btn ui-btn-icon-right ui-icon-plus" id="ID_SPEEDUP">Increase Arm Speed</a></li>
			<li><a href="#" class="ui-btn ui-btn-icon-right ui-icon-minus" id="ID_SPEEDDOWN">Decrease Arm Speed</a></li>
			<li><a href="#" class="ui-btn ui-btn-icon-right ui-icon-plus" id="ID_HAND_SPEED_UP">Increase Hand Speed</a></li>
			<li><a href="#" class="ui-btn ui-btn-icon-right ui-icon-minus" id="ID_HAND_SPEED_DOWN">Decrease Hand Speed</a></li>
            <li>
            <div class="ui-field-contain">
                <label for="pauseAll">Pause All:</label>
                <select name="pauseAll" id="pauseAll" data-role="flipswitch">
                    <option value="off">Off</option>
                    <option value="on">On</option>
                </select>
            </div>
            </li>
            <li>
            <div class="ui-field-contain">
                <label for="pauseHand">Pause Hand:</label>
                <select name="pauseHand" id="pauseHand" data-role="flipswitch">
                    <option value="off">Off</option>
                    <option value="on">On</option>
                </select>
            </div>
            </li>
			</ul>
			</div>
			
			<div data-role="collapsible" data-collapsed-icon="bullets" data-expanded-icon="bullets">
			<h4>Options</h4>
			<ul data-role="listview" data-inset="false">
			<li><a href="#ID_TAC_PAGE" data-transition="slidefade" class="ui-btn ui-btn-icon-right ui-icon-star">TAC Assessment...</a></li>
			<li><a href="#ID_MT_PAGE" data-transition="slidefade" class="ui-btn ui-btn-icon-right ui-icon-star">Motion Tester...</a></li>                
			<li></li>
			<li><a href="#" class="ui-btn ui-btn-icon-right ui-icon-refresh" id="ID_MYO1">Restart MYO #1</a></li>
			<li><a href="#" class="ui-btn ui-btn-icon-right ui-icon-refresh" id="ID_MYO2">Restart MYO #2</a></li>
			<li></li>
			<li><a href="#popupReboot" data-rel="popup" data-position-to="window" data-role="button" data-inline="true" data-transition="pop" data-icon="refresh" data-theme="a" data-iconpos="right">Reboot MPL</a></li>
			<li><a href="#popupShutdown" data-rel="popup" data-position-to="window" data-role="button" data-inline="true" data-transition="pop" data-icon="power" data-theme="a" data-iconpos="right">Shutdown MPL</a></li>
			</ul>
			</div>

			<div data-role="popup" id="popupReboot" data-overlay-theme="a" data-theme="b" data-dismissible="false" style="max-width:400px;" class="ui-corner-all">
			<div data-role="header" data-theme="a" class="ui-corner-top">
			<h1>Confirm Reboot</h1>
			</div>
			<div data-role="content" data-theme="d" class="ui-corner-bottom ui-content">
			<h3 class="ui-title">Reboot?</h3>
			<a href="#" data-role="button" data-inline="true" data-rel="back" data-theme="c">Cancel</a>
			<a href="#" data-role="button" data-inline="true" data-rel="back" data-transition="flow" data-theme="b" id="ID_REBOOT">OK</a>
			</div>
			</div>

			<div data-role="popup" id="popupShutdown" data-overlay-theme="a" data-theme="b" data-dismissible="false" style="max-width:400px;" class="ui-corner-all">
			<div data-role="header" data-theme="a" class="ui-corner-top">
			<h1>Confirm Shutdown</h1>
			</div>
			<div data-role="content" data-theme="d" class="ui-corner-bottom ui-content">
			<h3 class="ui-title">Shutdown?</h3>
			<a href="#" data-role="button" data-inline="true" data-rel="back" data-theme="c">Cancel</a>
			<a href="#" data-role="button" data-inline="true" data-rel="back" data-transition="flow" data-theme="b" id="ID_SHUTDOWN">OK</a>
			</div>
			</div>
			
			<p>Selected Motion: <span = id="msg_train"/></p>
			<div id="blueimp-image-carousel" class="blueimp-gallery blueimp-gallery-controls blueimp-gallery-carousel">
				<div class="slides"></div>
				<h3 class="title"></h3>
				<a class="prev">‹</a>
				<a class="next">›</a>
			</div>

            <!-- Training Switch -->
            <div class="ui-field-contain">
                <label for="trainSwitch">Add Data:</label>
                <select name="trainSwitch" id="trainSwitch" data-role="flipswitch">
                    <option value="off">Off</option>
                    <option value="on">On</option>
                </select>
            </div>
            
            <!-- Training Buttons -->
            <br>            
			<div data-role="controlgroup" data-type="horizontal">
				<a href="#" class="ui-btn" id="ID_CLEARCLASS">Clear</a>
				<a href="#" class="ui-btn" id="ID_CLEARALL">Reset</a>
				<a href="#" class="ui-btn" id="ID_SAVE">Save</a>
			</div>
            
            <!-- Helper Scripts for Image Carousel -->
			<script src="blueimp-gallery/js/blueimp-helper.js"></script>
			<script src="blueimp-gallery/js/blueimp-gallery.js"></script>
			<script src="blueimp-gallery/js/blueimp-gallery-fullscreen.js"></script>
			<script src="blueimp-gallery/js/blueimp-gallery-indicator.js"></script>
			<script src="blueimp-gallery/js/vendor/jquery.js"></script>
			<script src="blueimp-gallery/js/jquery.blueimp-gallery.js"></script>
			<script src="gallery-links.js"></script>

            <!-- Status Messages -->
            <br>
			<p><b>Status:</b></p>
			<p>Classification: <span = id="main_output"/></p>
			<p>Devices: <span = id="msg_status"/></p>
			<p>Server: <span = id="statusMsg"/></p>

        </div><!-- /content -->
    </div><!-- /page -->
	
	<!-- Motion Tester Page -->
	<div data-role="page" id="ID_MT_PAGE">
        <div data-role="header" data-theme="b" >
            <h1>Motion Tester</h1>
			<a href="#ID_MAIN_PAGE" data-role="button" data-icon="arrow-l">Back</a>
        </div><!-- /header -->
		<div data-role="content">
			<a href="#" class="ui-btn ui-btn-icon-right ui-icon-arrow-r" id="ID_ASSESSMENT_MT">Start Motion Tester</a>
            <div data-role="collapsible" data-collapsed-icon="bullets" data-expanded-icon="bullets">
				<h4>Options</h4>
				<ul data-role="listview" data-inset="false">
				<div class="ui-field-contain">
				  <label for="name">Repetitions:</label>
				  <input type="number" name="name" id="ID_MT_REPETITIONS" value="3">
				</div>
                <div class="ui-field-contain">
				  <label for="name">Timeout (s):</label>
				  <input type="number" name="name" id="ID_MT_TIMEOUT" value="5">
				</div>
                <div class="ui-field-contain">
				  <label for="name">Max Classifications:</label>
				  <input type="number" name="name" id="ID_MT_MAX_CLASSIFICATIONS" value="10">
				</div>
				</ul>
			</div>
			<p>Status: <span = id="mt_status"/></p>
			<p>Classifying: <span = id="mt_output"/></p>
			<img style="max-width: 100%;" src="img_arm_motions/No_Movement.png" id="ID_MT_IMAGE" alt="Motion Image">
			<div id="mtProgressBackground">
				<div id="mtProgressBar">
					<div id="mtProgressLabel">0%</div>
				 </div>
			</div>
		</div><!-- /content -->
    </div><!-- /page -->
	
	<!-- TAC Page -->
	<div data-role="page" id="ID_TAC_PAGE">
        <div data-role="header" data-theme="b" >
            <h1>Target Achievement Control</h1>
			<a href="#ID_MAIN_PAGE" data-role="button" data-icon="arrow-l">Back</a>
		</div><!-- /header -->
		<div data-role="content">
			<a href="#" class="ui-btn ui-btn-icon-right ui-icon-arrow-r" id="ID_ASSESSMENT_TAC1">Start TAC1</a>
			<a href="#" class="ui-btn ui-btn-icon-right ui-icon-arrow-r" id="ID_ASSESSMENT_TAC3">Start TAC3</a>
			
			<div data-role="collapsible" data-collapsed-icon="bullets" data-expanded-icon="bullets">
				<h4>Options</h4>
				<ul data-role="listview" data-inset="false">
				<div class="ui-field-contain">
				  <label for="name">Repetitions:</label>
				  <input type="number" name="name" id="ID_REPETITIONS" value="1">
				</div>
                <div class="ui-field-contain">
				  <label for="name">Timeout (s):</label>
				  <input type="number" name="name" id="ID_TIMEOUT" value="45">
				</div>
                <div class="ui-field-contain">
				  <label for="name">Dwell Time (s):</label>
				  <input type="number" name="name" id="ID_DWELL_TIME" value="2">
				</div>
				<div class="ui-field-contain">
				  <label for="name">Error (Degrees):</label>
				  <input type="number" name="name" id="ID_DEGREE_ERROR" value="5">
				</div>
				<div class="ui-field-contain">
				  <label for="name">Error (Grasp %):</label>
				  <input type="number" name="name" id="ID_GRASP_ERROR" value="5">
				</div>
				</ul>
			</div>
			
			<p>Status: <span = id="tac_status"/></p>
			<p>Classifying: <span = id="tac_output"/></p>
			<p><span = id="tacJoint1Name"/></p>
            <div id="tacJoint1Background">
				<div id="tacJoint1Target"></div>
				<div id="tacJoint1Bar">
					<div id="tacJoint1Label">0</div>
				 </div>
			</div>
			<p><span = id="tacJoint2Name"/></p>
            <div id="tacJoint2Background">
				<div id="tacJoint2Target"></div>
				<div id="tacJoint2Bar">
					<div id="tacJoint2Label">0</div>
				 </div>
			</div>
			<p><span = id="tacJoint3Name"/></p>
            <div id="tacJoint3Background">
				<div id="tacJoint3Target"></div>
				<div id="tacJoint3Bar">
					<div id="tacJoint3Label">0</div>
				 </div>
			</div>
		</div><!-- /content -->
    </div><!-- /page -->

</body>

</html>
